// debts.js - –ú–æ–¥—É–ª—å –¥–µ–±–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏
import * as firebase from './firebase.js';

let debtsData = [];
let managersData = [];
let departmentsData = [];
let clientCommentsData = [];
let paymentForecastsData = [];

// –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–±–∏—Ç–æ—Ä–∫–∏
const DEMO_DEBTS_DATA = [
    {
        clientCode: "00-00007283",
        clientName: "–¢–û–í –ê–ª—å—Ñ–∞ –¢—Ä–µ–π–¥",
        manager: "–Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω",
        department: "–í—ñ–¥–¥—ñ–ª –ø—Ä–æ–¥–∞–∂—É",
        totalDebt: 125000,
        overdueDebt: 85000,
        currentDebt: 40000,
        lastPayment: "2024-11-15",
        daysOverdue: 45,
        invoices: [
            { number: "INV-2024-001", date: "2024-10-01", amount: 50000, dueDate: "2024-10-31", status: "overdue" },
            { number: "INV-2024-002", date: "2024-11-01", amount: 35000, dueDate: "2024-11-30", status: "overdue" },
            { number: "INV-2024-003", date: "2024-12-01", amount: 40000, dueDate: "2024-12-31", status: "current" }
        ]
    },
    {
        clientCode: "00-00026426",
        clientName: "–§–û–ü –ü–µ—Ç—Ä–µ–Ω–∫–æ –û.–í.",
        manager: "–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä–æ",
        department: "–í—ñ–¥–¥—ñ–ª –ø—Ä–æ–¥–∞–∂—É",
        totalDebt: 75000,
        overdueDebt: 0,
        currentDebt: 75000,
        lastPayment: "2024-12-01",
        daysOverdue: 0,
        invoices: [
            { number: "INV-2024-004", date: "2024-12-05", amount: 75000, dueDate: "2025-01-05", status: "current" }
        ]
    },
    {
        clientCode: "00-00010339",
        clientName: "–¢–û–í –ë–µ—Ç–∞ –õ–æ–≥—ñ—Å—Ç–∏–∫",
        manager: "–°–∏–¥–æ—Ä–æ–≤ –°–∏–¥–æ—Ä",
        department: "–û–ø—Ç–æ–≤–∏–π –≤—ñ–¥–¥—ñ–ª",
        totalDebt: 200000,
        overdueDebt: 150000,
        currentDebt: 50000,
        lastPayment: "2024-10-20",
        daysOverdue: 60,
        invoices: [
            { number: "INV-2024-005", date: "2024-09-15", amount: 100000, dueDate: "2024-10-15", status: "overdue" },
            { number: "INV-2024-006", date: "2024-10-01", amount: 50000, dueDate: "2024-11-01", status: "overdue" },
            { number: "INV-2024-007", date: "2024-12-10", amount: 50000, dueDate: "2025-01-10", status: "current" }
        ]
    },
    {
        clientCode: "00-00008914",
        clientName: "–ü–ü –ì–∞–º–º–∞ –î–∏—Å—Ç—Ä–∏–±—É—Ü—ñ—è",
        manager: "–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ê–Ω–Ω–∞",
        department: "–û–ø—Ç–æ–≤–∏–π –≤—ñ–¥–¥—ñ–ª",
        totalDebt: 95000,
        overdueDebt: 30000,
        currentDebt: 65000,
        lastPayment: "2024-11-20",
        daysOverdue: 25,
        invoices: [
            { number: "INV-2024-008", date: "2024-11-01", amount: 30000, dueDate: "2024-12-01", status: "overdue" },
            { number: "INV-2024-009", date: "2024-12-10", amount: 65000, dueDate: "2025-01-10", status: "current" }
        ]
    },
    {
        clientCode: "00-00015627",
        clientName: "–¢–û–í –î–µ–ª—å—Ç–∞ –ü–ª—é—Å",
        manager: "–ú–µ–ª—å–Ω–∏–∫ –û–ª–µ–≥",
        department: "–†–æ–∑–¥—Ä—ñ–±–Ω–∏–π –≤—ñ–¥–¥—ñ–ª",
        totalDebt: 45000,
        overdueDebt: 45000,
        currentDebt: 0,
        lastPayment: "2024-09-30",
        daysOverdue: 75,
        invoices: [
            { number: "INV-2024-010", date: "2024-09-15", amount: 45000, dueDate: "2024-10-15", status: "overdue" }
        ]
    }
];

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª—è –¥–µ–±–∏—Ç–æ—Ä–∫–∏
 */
export function initDebtsModule(container) {
    console.log('initDebtsModule called', container);
    if (!container) return;
    
    container.innerHTML = `
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">–î–µ–±—ñ—Ç–æ—Ä—Å—å–∫–∞ –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω—ñ—Å—Ç—å</h1>
                    <p class="mt-2 text-gray-400">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω–æ—Å—Ç—è–º–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportDebtsToExcel()" 
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        üìä –ï–∫—Å–ø–æ—Ä—Ç Excel
                    </button>
                    <button onclick="refreshDebtsData()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        üîÑ –û–Ω–æ–≤–∏—Ç–∏
                    </button>
                </div>
            </div>
            <div id="debts-filters-container" class="mb-4"></div>
            <div id="debts-summary-container" class="mb-4"></div>
            <div id="debts-content-container" class="mb-4"></div>
        </div>
    `;

    loadDebtsData();
}

/**
 * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–µ–±–∏—Ç–æ—Ä–∫–∏
 */
async function loadDebtsData() {
    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showLoadingState();
        
        // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ
        // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç: const response = await fetch('API_URL_FOR_DEBTS');
        debtsData = DEMO_DEBTS_DATA;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –æ—Ç–¥–µ–ª—ã –∏–∑ Firebase
        const companyId = window.state?.currentCompanyId;
        if (companyId) {
            const [employeesSnap, departmentsSnap, commentsSnap, forecastsSnap] = await Promise.all([
                firebase.getDocs(firebase.collection(firebase.db, `companies/${companyId}/employees`)),
                firebase.getDocs(firebase.collection(firebase.db, `companies/${companyId}/departments`)),
                firebase.getDocs(firebase.collection(firebase.db, `companies/${companyId}/debtComments`)),
                firebase.getDocs(firebase.collection(firebase.db, `companies/${companyId}/paymentForecasts`))
            ]);
            
            managersData = employeesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            departmentsData = departmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            clientCommentsData = commentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            paymentForecastsData = forecastsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        
        hideLoadingState();
        renderDebtsFilters();
        renderDebtsSummary();
        renderDebtsTable();
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ–±—ñ—Ç–æ—Ä–∫–∏:', error);
        showErrorState('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
    }
}

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
 */
function showLoadingState() {
    const contentContainer = document.getElementById('debts-content-container');
    if (!contentContainer) return;
    
    contentContainer.innerHTML = `
        <div class="text-center p-8">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-300">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–µ–±—ñ—Ç–æ—Ä–∫–∏...</p>
        </div>
    `;
}

/**
 * –°–∫—Ä—ã—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
 */
function hideLoadingState() {
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–æ –≤ renderDebtsTable
}

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–∫–∏
 */
function showErrorState(message) {
    const contentContainer = document.getElementById('debts-content-container');
    if (!contentContainer) return;
    
    contentContainer.innerHTML = `
        <div class="text-center p-8 bg-red-900 rounded-lg">
            <p class="text-red-200 text-lg">${message}</p>
            <button onclick="loadDebtsData()" 
                    class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
            </button>
        </div>
    `;
}

/**
 * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ñ–∏–ª—å—Ç—Ä–æ–≤
 */
function renderDebtsFilters() {
    const filtersContainer = document.getElementById('debts-filters-container');
    if (!filtersContainer) return;
    
    const managers = [...new Set(debtsData.map(d => d.manager))];
    const departments = [...new Set(debtsData.map(d => d.department))];
    
    filtersContainer.innerHTML = `
        <div class="bg-gray-700 rounded-lg p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-200">–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
                    <select id="manager-filter" class="dark-input bg-gray-600 text-gray-200 w-full">
                        <option value="">–í—Å—ñ –º–µ–Ω–µ–¥–∂–µ—Ä–∏</option>
                        ${managers.map(m => `<option value="${m}">${m}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-200">–í—ñ–¥–¥—ñ–ª:</label>
                    <select id="department-filter" class="dark-input bg-gray-600 text-gray-200 w-full">
                        <option value="">–í—Å—ñ –≤—ñ–¥–¥—ñ–ª–∏</option>
                        ${departments.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-200">–¢–∏–ø –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω–æ—Å—Ç—ñ:</label>
                    <select id="debt-type-filter" class="dark-input bg-gray-600 text-gray-200 w-full">
                        <option value="">–í—Å—ñ</option>
                        <option value="overdue">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∞</option>
                        <option value="current">–ü–æ—Ç–æ—á–Ω–∞</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-200">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</label>
                    <select id="sort-filter" class="dark-input bg-gray-600 text-gray-200 w-full">
                        <option value="debt-desc">–ë–æ—Ä–≥ (–∑–º–µ–Ω—à–µ–Ω–Ω—è)</option>
                        <option value="debt-asc">–ë–æ—Ä–≥ (–∑—Ä–æ—Å—Ç–∞–Ω–Ω—è)</option>
                        <option value="overdue-desc">–ü—Ä–æ—Å—Ç—Ä–æ—á–∫–∞ (–∑–º–µ–Ω—à–µ–Ω–Ω—è)</option>
                        <option value="days-desc">–î–Ω—ñ–≤ –ø—Ä–æ—Å—Ç—Ä–æ—á–∫–∏</option>
                        <option value="name-asc">–ù–∞–∑–≤–∞ –∫–ª—ñ—î–Ω—Ç–∞</option>
                    </select>
                </div>
            </div>
        </div>
    `;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('manager-filter').onchange = applyFilters;
    document.getElementById('department-filter').onchange = applyFilters;
    document.getElementById('debt-type-filter').onchange = applyFilters;
    document.getElementById('sort-filter').onchange = applyFilters;
}

/**
 * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
 */
function applyFilters() {
    const managerFilter = document.getElementById('manager-filter').value;
    const departmentFilter = document.getElementById('department-filter').value;
    const debtTypeFilter = document.getElementById('debt-type-filter').value;
    const sortFilter = document.getElementById('sort-filter').value;
    
    let filteredData = [...debtsData];
    
    if (managerFilter) {
        filteredData = filteredData.filter(d => d.manager === managerFilter);
    }
    
    if (departmentFilter) {
        filteredData = filteredData.filter(d => d.department === departmentFilter);
    }
    
    if (debtTypeFilter === 'overdue') {
        filteredData = filteredData.filter(d => d.overdueDebt > 0);
    } else if (debtTypeFilter === 'current') {
        filteredData = filteredData.filter(d => d.currentDebt > 0 && d.overdueDebt === 0);
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    switch(sortFilter) {
        case 'debt-desc':
            filteredData.sort((a, b) => b.totalDebt - a.totalDebt);
            break;
        case 'debt-asc':
            filteredData.sort((a, b) => a.totalDebt - b.totalDebt);
            break;
        case 'overdue-desc':
            filteredData.sort((a, b) => b.overdueDebt - a.overdueDebt);
            break;
        case 'days-desc':
            filteredData.sort((a, b) => b.daysOverdue - a.daysOverdue);
            break;
        case 'name-asc':
            filteredData.sort((a, b) => a.clientName.localeCompare(b.clientName));
            break;
    }
    
    renderDebtsSummary(filteredData);
    renderDebtsTable(filteredData);
}

/**
 * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–≤–æ–¥–∫–∏
 */
function renderDebtsSummary(data = debtsData) {
    const summaryContainer = document.getElementById('debts-summary-container');
    if (!summaryContainer) return;
    
    const totalDebt = data.reduce((sum, d) => sum + d.totalDebt, 0);
    const overdueDebt = data.reduce((sum, d) => sum + d.overdueDebt, 0);
    const currentDebt = data.reduce((sum, d) => sum + d.currentDebt, 0);
    const clientsCount = data.length;
    const overdueClientsCount = data.filter(d => d.overdueDebt > 0).length;
    const avgDaysOverdue = data.filter(d => d.daysOverdue > 0).reduce((sum, d) => sum + d.daysOverdue, 0) / 
                          (data.filter(d => d.daysOverdue > 0).length || 1);
    
    summaryContainer.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-2xl font-bold text-white">${clientsCount}</div>
                <div class="text-sm text-gray-400">–ö–ª—ñ—î–Ω—Ç—ñ–≤ –∑ –±–æ—Ä–≥–æ–º</div>
            </div>
            <div class="bg-blue-600 rounded-lg p-4">
                <div class="text-2xl font-bold text-white">${formatCurrency(totalDebt)}</div>
                <div class="text-sm text-blue-200">–ó–∞–≥–∞–ª—å–Ω–∏–π –±–æ—Ä–≥</div>
            </div>
            <div class="bg-red-600 rounded-lg p-4">
                <div class="text-2xl font-bold text-white">${formatCurrency(overdueDebt)}</div>
                <div class="text-sm text-red-200">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π –±–æ—Ä–≥</div>
            </div>
            <div class="bg-green-600 rounded-lg p-4">
                <div class="text-2xl font-bold text-white">${formatCurrency(currentDebt)}</div>
                <div class="text-sm text-green-200">–ü–æ—Ç–æ—á–Ω–∏–π –±–æ—Ä–≥</div>
            </div>
            <div class="bg-yellow-600 rounded-lg p-4">
                <div class="text-2xl font-bold text-white">${overdueClientsCount}</div>
                <div class="text-sm text-yellow-200">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∏</div>
            </div>
            <div class="bg-purple-600 rounded-lg p-4">
                <div class="text-2xl font-bold text-white">${Math.round(avgDaysOverdue)}</div>
                <div class="text-sm text-purple-200">–°–µ—Ä–µ–¥–Ω—è –ø—Ä–æ—Å—Ç—Ä–æ—á–∫–∞</div>
            </div>
        </div>
    `;
}

/**
 * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –¥–µ–±–∏—Ç–æ—Ä–∫–∏
 */
function renderDebtsTable(data = debtsData) {
    const contentContainer = document.getElementById('debts-content-container');
    if (!contentContainer) return;
    
    contentContainer.innerHTML = `
        <div class="bg-white dark:bg-gray-700 rounded-lg overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="px-4 py-3 text-left text-white">–ö–ª—ñ—î–Ω—Ç</th>
                        <th class="px-4 py-3 text-left text-white">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                        <th class="px-4 py-3 text-right text-white">–ó–∞–≥–∞–ª—å–Ω–∏–π –±–æ—Ä–≥</th>
                        <th class="px-4 py-3 text-right text-white">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π</th>
                        <th class="px-4 py-3 text-center text-white">–î–Ω—ñ–≤ –ø—Ä–æ—Å—Ç—Ä–æ—á–∫–∏</th>
                        <th class="px-4 py-3 text-center text-white">–û—Å—Ç–∞–Ω–Ω—è –æ–ø–ª–∞—Ç–∞</th>
                        <th class="px-4 py-3 text-center text-white">–°—Ç–∞—Ç—É—Å</th>
                        <th class="px-4 py-3 text-center text-white">–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(debt => {
                        const hasComment = clientCommentsData.find(c => c.clientCode === debt.clientCode);
                        const hasForecast = paymentForecastsData.find(f => f.clientCode === debt.clientCode);
                        return `
                            <tr class="border-b border-gray-600 hover:bg-gray-600">
                                <td class="px-4 py-3 text-white">
                                    <div class="font-medium">${debt.clientName}</div>
                                    <div class="text-sm text-gray-400">${debt.clientCode}</div>
                                    ${hasComment ? '<div class="text-xs text-blue-400">üí¨ –Ñ –∫–æ–º–µ–Ω—Ç–∞—Ä</div>' : ''}
                                </td>
                                <td class="px-4 py-3 text-gray-200">
                                    <div>${debt.manager}</div>
                                    <div class="text-sm text-gray-400">${debt.department}</div>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span class="font-medium text-white">${formatCurrency(debt.totalDebt)}</span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span class="font-medium ${debt.overdueDebt > 0 ? 'text-red-400' : 'text-green-400'}">
                                        ${formatCurrency(debt.overdueDebt)}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="px-2 py-1 rounded-full text-xs ${
                                        debt.daysOverdue === 0 ? 'bg-green-600 text-white' :
                                        debt.daysOverdue <= 30 ? 'bg-yellow-600 text-white' :
                                        debt.daysOverdue <= 60 ? 'bg-orange-600 text-white' :
                                        'bg-red-600 text-white'
                                    }">
                                        ${debt.daysOverdue || 0}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center text-gray-200">${debt.lastPayment}</td>
                                <td class="px-4 py-3 text-center">
                                    ${hasForecast ? 
                                        '<div class="text-xs text-green-400">üìÖ –Ñ –ø—Ä–æ–≥–Ω–æ–∑</div>' : 
                                        '<div class="text-xs text-gray-500">–ë–µ–∑ –ø—Ä–æ–≥–Ω–æ–∑—É</div>'
                                    }
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="showDebtDetails('${debt.clientCode}')" 
                                            class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                        –î–µ—Ç–∞–ª—ñ
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
 */
window.showDebtDetails = function(clientCode) {
    const debt = debtsData.find(d => d.clientCode === clientCode);
    if (!debt) return;
    
    const existingComment = clientCommentsData.find(c => c.clientCode === clientCode);
    const existingForecast = paymentForecastsData.find(f => f.clientCode === clientCode);
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60';
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">–î–µ—Ç–∞–ª—ñ –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω–æ—Å—Ç—ñ: ${debt.clientName}</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-lg font-bold text-white">${formatCurrency(debt.totalDebt)}</div>
                    <div class="text-sm text-gray-400">–ó–∞–≥–∞–ª—å–Ω–∏–π –±–æ—Ä–≥</div>
                </div>
                <div class="bg-red-600 rounded-lg p-4">
                    <div class="text-lg font-bold text-white">${formatCurrency(debt.overdueDebt)}</div>
                    <div class="text-sm text-red-200">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π</div>
                </div>
                <div class="bg-green-600 rounded-lg p-4">
                    <div class="text-lg font-bold text-white">${formatCurrency(debt.currentDebt)}</div>
                    <div class="text-sm text-green-200">–ü–æ—Ç–æ—á–Ω–∏–π</div>
                </div>
                <div class="bg-yellow-600 rounded-lg p-4">
                    <div class="text-lg font-bold text-white">${debt.daysOverdue}</div>
                    <div class="text-sm text-yellow-200">–î–Ω—ñ–≤ –ø—Ä–æ—Å—Ç—Ä–æ—á–∫–∏</div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-bold text-white mb-3">–†–∞—Ö—É–Ω–∫–∏</h3>
                <div class="bg-gray-700 rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-600">
                            <tr>
                                <th class="px-4 py-2 text-left text-white">‚Ññ –†–∞—Ö—É–Ω–∫—É</th>
                                <th class="px-4 py-2 text-center text-white">–î–∞—Ç–∞</th>
                                <th class="px-4 py-2 text-right text-white">–°—É–º–∞</th>
                                <th class="px-4 py-2 text-center text-white">–¢–µ—Ä–º—ñ–Ω –æ–ø–ª–∞—Ç–∏</th>
                                <th class="px-4 py-2 text-center text-white">–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${debt.invoices.map(invoice => `
                                <tr class="border-b border-gray-600">
                                    <td class="px-4 py-2 text-white">${invoice.number}</td>
                                    <td class="px-4 py-2 text-center text-gray-200">${invoice.date}</td>
                                    <td class="px-4 py-2 text-right text-white">${formatCurrency(invoice.amount)}</td>
                                    <td class="px-4 py-2 text-center text-gray-200">${invoice.dueDate}</td>
                                    <td class="px-4 py-2 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs ${
                                            invoice.status === 'overdue' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'
                                        }">
                                            ${invoice.status === 'overdue' ? '–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ' : '–ü–æ—Ç–æ—á–Ω–∏–π'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-bold text-white mb-3">–ö–æ–º–µ–Ω—Ç–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
                    <textarea id="manager-comment-${clientCode}" 
                              class="w-full h-24 bg-gray-700 text-white rounded border border-gray-600 p-3"
                              placeholder="–î–æ–¥–∞–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä –ø—Ä–æ —Å—Ç–∞–Ω –æ–ø–ª–∞—Ç–∏...">${existingComment?.comment || ''}</textarea>
                    ${existingComment ? `<div class="text-xs text-gray-400 mt-1">–û–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(existingComment.updatedAt?.seconds * 1000).toLocaleDateString()}</div>` : ''}
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white mb-3">–ü—Ä–æ–≥–Ω–æ–∑ –æ–ø–ª–∞—Ç–∏</h3>
                    <input type="date" id="payment-forecast-${clientCode}" 
                           class="w-full bg-gray-700 text-white rounded border border-gray-600 p-3 mb-2"
                           value="${existingForecast?.forecastDate || ''}">
                    <input type="number" id="payment-amount-${clientCode}" 
                           class="w-full bg-gray-700 text-white rounded border border-gray-600 p-3"
                           placeholder="–°—É–º–∞ –æ—á—ñ–∫—É–≤–∞–Ω–æ—ó –æ–ø–ª–∞—Ç–∏"
                           value="${existingForecast?.forecastAmount || ''}">
                    ${existingForecast ? `<div class="text-xs text-gray-400 mt-1">–ü—Ä–æ–≥–Ω–æ–∑ –≤—ñ–¥: ${new Date(existingForecast.createdAt?.seconds * 1000).toLocaleDateString()}</div>` : ''}
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="this.closest('.fixed').remove()" 
                        class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                    –ó–∞–∫—Ä–∏—Ç–∏
                </button>
                <button onclick="saveDebtComment('${clientCode}')" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    –ó–±–µ—Ä–µ–≥—Ç–∏
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
};

/**
 * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –¥–µ–±–∏—Ç–æ—Ä–∫–µ
 */
window.saveDebtComment = async function(clientCode) {
    const comment = document.getElementById(`manager-comment-${clientCode}`).value;
    const forecastDate = document.getElementById(`payment-forecast-${clientCode}`).value;
    const forecastAmount = document.getElementById(`payment-amount-${clientCode}`).value;
    
    try {
        const companyId = window.state?.currentCompanyId;
        const userId = window.state?.currentUserId;
        
        if (!companyId) {
            alert('–ü–æ–º–∏–ª–∫–∞: –ö–æ–º–ø–∞–Ω—ñ—è –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        if (comment.trim()) {
            const commentData = {
                clientCode,
                comment: comment.trim(),
                updatedAt: firebase.serverTimestamp(),
                updatedBy: userId
            };
            
            await firebase.setDoc(
                firebase.doc(firebase.db, `companies/${companyId}/debtComments`, clientCode),
                commentData,
                { merge: true }
            );
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –æ–ø–ª–∞—Ç—ã
        if (forecastDate && forecastAmount) {
            const forecastData = {
                clientCode,
                forecastDate,
                forecastAmount: parseFloat(forecastAmount),
                createdAt: firebase.serverTimestamp(),
                createdBy: userId
            };
            
            await firebase.setDoc(
                firebase.doc(firebase.db, `companies/${companyId}/paymentForecasts`, clientCode),
                forecastData,
                { merge: true }
            );
        }
        
        alert('–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        document.querySelector('.fixed').remove();
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        loadDebtsData();
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
    }
};

/**
 * –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
 */
window.exportDebtsToExcel = function() {
    alert('–§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –≤ Excel –±—É–¥–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ä–µ–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö');
};

/**
 * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
 */
window.refreshDebtsData = function() {
    loadDebtsData();
};

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
 */
function formatCurrency(amount) {
    return new Intl.NumberFormat('uk-UA', {
        style: 'currency',
        currency: 'UAH',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}